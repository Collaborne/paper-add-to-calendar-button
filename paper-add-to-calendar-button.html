<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="paper-add-to-calendar-button">
	<template>
		<style>
			:host {
				display: block;
			}
			paper-menu-button {
				--paper-menu-button-content: {
					border-radius: 5px;
				}
			}
			paper-button {
				@apply --paper-add-to-calendar-button-button;
			}
			iron-icon {
				margin-right: 8px;
			}
			.actions {
				padding: 8px 0;
				text-align: left;
				min-width: 120px;
			}
			.action {
				display: block;
				padding: 8px 16px;
				cursor: pointer;
				color: initial;
				text-decoration: none;
				@apply --paper-add-to-calendar-button-action;
			}
			.action:hover {
				background: var(--paper-add-to-calendar-button-action-hover-background-color, lightgray);
			}
		</style>
		<paper-menu-button id="menu" horizontal-offset="8" vertical-offset="40">
			<paper-button slot="dropdown-trigger">
				<iron-icon icon="icons:file-download"></iron-icon>
				[[actionText]]
			</paper-button>
			<div class="actions" slot="dropdown-content">
				<a
					class="action"
					href="[[computeGoogle(title, _startDate, _endDate, duration, description, location)]]"
					on-tap="_closeMenu"
					target="_blank"
				>Google</a>
				<a
					class="action"
					href="[[computeYahoo(title, _startDate, _endDate, duration, description, location)]]"
					on-tap="_closeMenu"
					target="_blank"
				>Yahoo</a>
				<a
					class="action"
					href="[[computeIcs(title, _startDate, _endDate, duration, description, location)]]"
					on-tap="_closeMenu"
				>iCal</a>
				<a
					class="action"
					href="[[computeIcs(title, _startDate, _endDate, duration, description, location)]]"
					on-tap="_closeMenu"
				>Outlook</a>
			</div>
		</paper-menu-button>
	</template>

	<script>
		/**
		 * `paper-add-to-calendar-button`
		 * Polymer button that allows downloading an event into various calendars
		 *
		 * @customElement
		 * @polymer
		 * @demo demo/index.html
		 */
		class PaperAddToCalendarButton extends Polymer.Element {
			static get is() {
				return 'paper-add-to-calendar-button';
			}

			static get properties() {
				return {
					title: String,
					start: String,
					end: String,
					duration: Number,
					description: String,
					location: String,

					actionText: {
						type: String,
						value: 'Add to calendar',
					},

					_startDate: {
						type: Date,
						computed: '_toDate(start)',
					},
					_endDate: {
						type: Date,
						computed: '_toDate(end)',
					},
				};
			}

			computeGoogle(title, startDate, endDate, duration, description, location) {
				const startTime = this.formatTime(startDate);
				const endTime = this.calculateEndTime(endDate, startDate, duration);

				return encodeURI([
					'https://www.google.com/calendar/render',
					'?action=TEMPLATE',
					'&text=' + (title || ''),
					'&dates=' + (startTime || ''),
					'/' + (endTime || ''),
					'&details=' + (description || ''),
					'&location=' + (location || ''),
					'&sprop=&sprop=name:'
				].join(''));
			}

			_padZeros(value) {
				return ('00' + Math.floor(value)).slice(-2);
			}

			computeYahoo(title, startDate, endDate, duration, description, location) {
				if (!startDate) {
					return;
				}

				const MIN_IN_MILISEC = 60 * 1000;
				const eventDuration = endDate ? (endDate.getTime() - startDate.getTime()) / MIN_IN_MILISEC : duration;

				// Convert the duration from minutes to hhmm (Yahoo format)
				const yahooHourDuration = this._padZeros(eventDuration / 60);
				const yahooMinuteDuration = this._padZeros(eventDuration % 60);
				const yahooEventDuration = `${yahooHourDuration}${yahooMinuteDuration}`;

				// Remove timezone from event time
				const st = this.formatTime(startDate) || '';

				return encodeURI([
					'http://calendar.yahoo.com/?v=60&view=d&type=20',
					'&title=' + (title || ''),
					'&st=' + st,
					'&dur=' + (yahooEventDuration || ''),
					'&desc=' + (description || ''),
					'&in_loc=' + (location || '')
				].join(''));
			}

			computeIcs(title, startDate, endDate, duration, description, location) {
				var startTime = this.formatTime(startDate);
				var endTime = this.calculateEndTime(endDate, startDate, duration);

				return encodeURI(
					'data:text/calendar;charset=utf8,' + [
						'BEGIN:VCALENDAR',
						'VERSION:2.0',
						'BEGIN:VEVENT',
						'DTSTART:' + (startTime || ''),
						'DTEND:' + (endTime || ''),
						'SUMMARY:' + (title || ''),
						'DESCRIPTION:' + (description || ''),
						'LOCATION:' + (location || ''),
						'END:VEVENT',
						'END:VCALENDAR'].join('\n'));
			}

			formatTime(date) {
				if (!date) {
					return;
				}

				return date.toISOString().replace(/-|:|\.\d+/g, '');
			}

			calculateEndTime(endDate, startDate, duration) {
				const MIN_IN_MILISEC = 60 * 1000;
				const end = endDate || new Date(startDate.getTime() + (duration * MIN_IN_MILISEC));
				return this.formatTime(end);
			}

			_toDate(dateStr) {
				return new Date(dateStr);
			}

			_closeMenu() {
				this.$.menu.close();
			}
		}

		window.customElements.define(PaperAddToCalendarButton.is, PaperAddToCalendarButton);
	</script>
</dom-module>
